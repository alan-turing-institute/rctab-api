# RCTab API - Development data

It is useful to have access to test data that can be loaded into the local database when making changes to the code base.
Manually creating and inputting mock data into the local database is time consuming and can lead to developments being made by developers using different data sets.

To standardise the data for development purposes, data for each of the following EA tables will be created as named JSON files:

- accounting.allocations
- accounting.approvals
- accounting.cost_recovery
- accounting.cost_recovery_log
- accounting.costmanagement
- accounting.emails
- accounting.finance
- accounting.persistence
- accounting.status
- accounting.subscription
- accounting.subscription_details
- accounting.usage

In these files, each user id and associated email is replaced with an anonymised version: E.g. johndoe with an email of jdoe@someemail.com is replaced with user_n with email user_n@mail.com, where n is the nth user.

## Loading development data

Note: for the following script to work you must first ensure the [local database is set up](<https://github.com/alan-turing-institute/rctab-api#postgresql-container>).

The development data stored in the json files can be loaded into your local database by running:

```bash
python populate_local_db.py [path]
```

where path is the location of the directory containing the dev JSON files (e.g. `RCTAB/test_data`).

Each file is processed in turn, starting with accounting.subscription.

First the contents of the JSON file are loaded. The admin field is then updated with the users admin UUID from the table `user_rbac` and end dates are set to be 180 days in the future from the day the script is ran. This ensures you will have access to the data and that the data corresponds to active projects. The contents are then loaded into the appropriate local database table.

One you have run `populate_local_db.py` you should be able to see the contents in the local database.

## Generating dev data

The dev data is generated by running `get_dev_data.py`. To run this file you will need to have access to the production database. Credentials are read from a secrets file called `.get_dev_secrets` located in the same directory as `get_dev_data.py`. You will need to create such a file and populate it with your access credentials to use the script, along with the id of the subscription you wish to retrieve data for.

The file should look like this:

```txt
dbname=<>
user=<>
host=<>
password=<>
port=<>
subscription_id=<>
```

with `<>` replaced with the appropriate values.

Note: `.get_dev_secrets` is included in the `.gitignore` and should **never** be uploaded to GitHub!

For details on running the script, run:

```bash
python get_dev_data.py -h
```

## Retrieving failed emails

If an API key or from email is missing, an email that should be sent automatically will not be sent. Instead, the details of the email will be recorded in a table called `failed_emails` and logs an email. A logging message will state when this has occurred. The email that should have been sent can be retrieved to be sent manually using the script `get_failed_emails.py`. This pulls an email from the database and saves it locally, either to a default or specified location (use `--help` for details). The email file can then be loaded into an email app, such as outlook, fully formatted and ready to be forwarded on manually by the user. In addition, the script also has options to delete data from the failed_emails table and extract specific rows.
